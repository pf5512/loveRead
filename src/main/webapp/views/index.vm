<script src="${rc.contextPath}/resources/js/app.upchat.js?v=$!staticVersion" ></script> 
<script src="${rc.contextPath}/resources/js/jquery.form.js?v=$!staticVersion" ></script>
<div class="swiper-container home-drawer-swiper">
	<div class="swiper-wrapper">
		<div class="swiper-slide menu-drawer">	
		    <img id="headerIcon" src="${rc.contextPath}/resources/images/hackthon/user_header_icon.png"></img>
		    <ul>
		        <li onclick="javascript:window.location.href='${rc.contextPath}/userHome/myBookList'"><p>我的图书</p></li>
		        <li onclick="javascript:window.location.href='${rc.contextPath}/userHome/borrowHistory'"><p>借阅记录</p></li>
		        <li onclick="javascript:window.location.href='${rc.contextPath}/userHome/scoreHistory'"><p>我的积分</p></li>
		        <!-- <li onclick="javascript:zzrw.alert('敬请期待')"><p>公告</p></li> -->
		        <li onclick="javascript:window.location.href='${rc.contextPath}/aboutUs'"><p>关于</p></li>
		    </ul>
		</div>
		<div class="swiper-slide">
			<div class="top-menu">
			    <div class="search-bar">
			        <img class="menu-icon" src="${rc.contextPath}/resources/images/hackthon/top_menu.png"></img>
			        <p>
			            <img class="search-icon" src="${rc.contextPath}/resources/images/hackthon/search.png"></img>
			            <input id="keywords" type="text" placeholder="搜索" onkeypress="if(event.keyCode==13) {var keywords = $('input#keywords').val();window.location.href='${rc.contextPath}/book/search?keywords=' + keywords + ''}">
			        </p>
			    </div>
			    <div class="main-oper-bar">
			        <ul>
			            <li>
			                <div class="main-list-item" id="borrowByCode">
			                    <img src="${rc.contextPath}/resources/images/hackthon/borrow_by_code.png"></img>
			                    <p>码上借</p>
			                </div>
			            </li>
			            <li>
			                <div class="main-list-item" id="uploadBook">
			                    <img src="${rc.contextPath}/resources/images/hackthon/upload_book.png"></img>
			                    <p>上传</p>
			                </div>
			            </li>
			            <li>
			                <div class="main-list-item" id="returnByCode">
			                    <img src="${rc.contextPath}/resources/images/hackthon/return_by_code.png"></img>
			                    <p>码上还</p>
			                </div>
			            </li>
			        </ul>
			    </div>
			</div>
			<div class="swiper-container index-notice">
            	<ul class="swiper-wrapper">
            		<li class="swiper-slide">点击“积分”有惊喜哦！</li>
            		<li class="swiper-slide">点击“上传”即可分享您的图书啦！</li>
            		<li class="swiper-slide">点击“码上借”即可出借您上传过的图书哦！</li>
            		<li class="swiper-slide">快去“圈子”看看大家都在说什么吧！</li>
				</ul>
			</div>
			<div class="second-oper-bar">
				<ul>
					<li>
						<!--<div class="second-list-item" onclick="window.location.href='${rc.contextPath}/allBook'">-->
						<div class="second-list-item" onclick="window.location.href='${rc.contextPath}/allBookAndUser'">
							<img src="${rc.contextPath}/resources/images/hackthon/all_icon.png"></img>
							<p>所有</p>
						</div>
					</li>
					<li>
						<div class="second-list-item" onclick="window.location.href='${rc.contextPath}/rank'">
							<img src="${rc.contextPath}/resources/images/hackthon/rank_icon.png"></img>
							<p>排行</p>
						</div>
					</li>
					<li>
						<div class="second-list-item" onclick="window.location.href='${rc.contextPath}/userHome/scoreHistory'">
							<img src="${rc.contextPath}/resources/images/hackthon/exchange_icon.png"></img>
							<p>积分</p>
						</div>
					</li>
					<li>
						<div class="second-list-item" onclick="window.location.href='${rc.contextPath}/review/list'">
							<img src="${rc.contextPath}/resources/images/hackthon/borrow_icon.png"></img>
							<p>圈子</p>
						</div>
					</li>
				</ul>
			</div>
			<div class="home-top-rank">
			    <p class="home-top-title">猜你喜欢</p>
			    <div class="swiper-container home-rank-swiper">
					<div class="swiper-wrapper" id="homeRankList">
					</div>
				</div>
			</div>
			<div class='menu-drawer-shadow'></div>
		</div>
	</div>
</div>

<script>
$(document).ready(function(){
	var homeSwiper = new Swiper('.home-drawer-swiper', {
        slidesPerView: 'auto',
        initialSlide:1,
		onTouchStart:function(){
			$(".menu-drawer").css('height',$(window).height());
		},
		onSlideNextStart:function(swiper){
			$(".menu-drawer-shadow").css('display','none');	
		},
		onSlidePrevStart:function(swiper){
    		$(".menu-drawer-shadow").css('height',$(window).height());
    		$(".menu-drawer-shadow").css('display','block');
		}
    });

	var noticeSwiper = new Swiper('.index-notice', {
		slidesPerView: 1,
		autoplay : 1000,
		speed : 1000,
		loop : true,
		direction : 'vertical'
	});
	
    $(".menu-icon").click(function(){
    	$(".menu-drawer").css('height',$(window).height());
    	homeSwiper.slideTo(0);
    	$(".menu-drawer-shadow").css('height',$(window).height());
    	$(".menu-drawer-shadow").css('display','block');
    });
    
    $(".menu-drawer-shadow").click(function(){
        homeSwiper.slideTo(1);
        $(".menu-drawer-shadow").css('display','none');
    });
    
    $("#borrowByCode").click(function(){
        window.location.href="${rc.contextPath}/userHome/myBorrowAbleList";
    });

    $("#returnByCode").click(function(){
        window.location.href="${rc.contextPath}/userHome/myReturnList";
    });

	$("#uploadBook").click(function(){
		showUploadTypeModal();
	});

    //获取TOP10
    $.ajax({
        url:'${rc.contextPath}/getTopThree',
        dataType:'json',
        success:function(data){
            $("#homeRankList").empty();
            var html = "";
            for(i = 0;i<data.books.length;i++){
                html = html + "<div class='swiper-slide top-rank-item' onclick='jumpDetail("+data.books[i].bookId+")'>";
                html = html + "<p style='font-size:12px;'>" + data.books[i].ownerName + "</p>";
                html = html + "<img src='"+data.books[i].cover+"'></img>";
                html = html + "<p>" + data.books[i].bookName + "</p>";
                html = html + "</div>";
            }
            $("#homeRankList").append(html);
            
            var swiper = new Swiper('.home-rank-swiper', {
		        slidesPerView: 4,
		        paginationClickable: true,
		        spaceBetween: 10,
				initialSlide: 0
		    });
        },
        error:function(){
        }
    });
   
});

function jumpDetail(id){
    window.location.href="${rc.contextPath}/book/bookDetail?bookId="+id;
}

function getBookInfoFromDouban(isbn){
	$.ajax({
        async : true,
        url : "https://api.douban.com/v2/book/isbn/"+isbn,
        type : "GET",
        dataType : "jsonp", // 返回的数据类型，设置为JSONP方式
        jsonp : 'callback', //指定一个查询参数名称来覆盖默认的 jsonp 回调参数名 callback
        jsonpCallback: 'handleResponse', //设置回调函数名
        data : {
            q : "javascript", 
            count : 1
        },
		timeout : 5000,
        success: function(response, status, xhr){
            //zzrw.alert('状态为：' + status + ',状态是：' + xhr.statusText + ";-----;" + response);
			$.ajax({
				url:'${rc.contextPath}/douban/upload',
				data:{
					bookStr:JSON.stringify(response)
				},
				type:'post',
				success:function(){
					removeLoading();
					zzrw.alert("上传成功，进入我的图书列表！",function(){
                                    window.location.href="${rc.contextPath}/userHome/myBookList";
                                })
				},
				error:function(){
					removeLoading();
					zzrw.alert("服务器异常，请重新拍照！");
				}
			});
        },
		error: function(XMLHttpRequest, textStatus, errorThrown){
			removeLoading();
			if(textStatus == 'timeout'){
				zzrw.alert("无效的ISBN号，未解析出对应的图书");
			}
		}
    });
}

function uploadBookInfoFromBouban(){
	$("#isbnModal").modal("hide");
	var isbnNo = $("#isbnInput").val();
	if(isbnNo == null || isbnNo == undefined || isbnNo == ""){
		zzrw.alert("ISBN号为空");
	}else{
		showLoading();
		//判断是否重复
		checkIfExpire(isbnNo);
		//getBookInfoFromBouban(isbnNo);
	}
}

function uploadBookByPhoto(){
	hideUploadTypeModal();
	UPCHAT.M.NAPI.choosePhoto(
        function(succ) {
            showLoading();
            $.ajax({
                type:'POST',
                url: "${rc.contextPath}/douban/analyze",
                dataType:'json',
                data: {
                    bookImg : succ.content
                },
                success: function(data) {
                    if(data.code == '0') {
						//判断是否重复
						checkIfExpire(data.data);
						//getBookInfoFromDouban(data.data);
                    }else{
						removeLoading();
                        zzrw.confirm("上传失败，选择其他上传方式？",function(){
                        	showUploadTypeModal();
                        });
                    }
                },
                error:function(){
					removeLoading();
                    zzrw.alert("解析异常，请重新拍照！");
                }
            })
        },
        function(fail) {
            util.showInfo('打开图片失败！');
        }
    );
}
//检测是否无法上传
function checkIfExpire(isbn){
	$.ajax({
		type:'POST',
		url: "${rc.contextPath}/book/checkIsbn",
		data:{
			isbn:isbn
		},
		dataType:'json',
		success:function(data){
			if(data.code == '0'){
				getBookInfoFromDouban(isbn);
			}else{
				removeLoading();
				zzrw.alert(data.message);
			}
		},
		error:function(){
			removeLoading();
			zzrw.alert("服务器异常，请稍后再试！");
		}
	});
}
</script>
